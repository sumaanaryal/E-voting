import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCVtWzM5URktOLbSYadPDUW8fMURI2TE8w",
  authDomain: "e-voting2082.firebaseapp.com",
  databaseURL: "https://e-voting2082-default-rtdb.firebaseio.com",
  projectId: "e-voting2082",
  storageBucket: "e-voting2082.firebasestorage.app",
  messagingSenderId: "546021327219",
  appId: "1:546021327219:web:4517f75740c8d4b6a84506"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentPage = 0;
const votes = { parent: '', voter: '', science: '', art: '', craft: '', overall: '' };

// ATTACH TO WINDOW SO BUTTONS WORK
window.startApp = function() {
    document.getElementById('landing').style.display = 'none';
    document.getElementById('main-container').style.display = 'flex';
};

window.nextPage = async function() {
    if (currentPage === 0) {
        const nameInput = document.getElementById('parentName').value.trim();
        const idInput = document.getElementById('voterId').value.trim();
        const idNum = parseInt(idInput);

        if (!nameInput || !idInput) {
            alert("Please enter both Name and Voter ID!");
            return;
        }

        if (idNum < 1 || idNum > 400) {
            alert("Access Denied: Voter ID must be between 1 and 400.");
            return;
        }

        try {
            const votesRef = ref(db, 'votes');
            const idQuery = query(votesRef, orderByChild('voter'), equalTo(idInput));
            const snapshot = await get(idQuery);

            if (snapshot.exists()) {
                alert("Security Alert: This Voter ID has already been used!");
                return;
            }
        } catch (error) {
            console.error(error);
            alert("Connection error. Try again.");
            return;
        }

        votes.parent = nameInput;
        votes.voter = idInput;
    }

    document.getElementById(`page-${currentPage}`).classList.remove('active');
    currentPage++;
    document.getElementById(`page-${currentPage}`).classList.add('active');
};

window.prevPage = function() {
    if (currentPage > 0) {
        document.getElementById(`page-${currentPage}`).classList.remove('active');
        currentPage--;
        document.getElementById(`page-${currentPage}`).classList.add('active');
    }
};

window.selectOption = function(category, value) {
    votes[category] = value;
};

window.submitVote = async function() {
    if (!votes.overall) {
        alert("Please provide an overall rating!");
        return;
    }

    try {
        await push(ref(db, 'votes'), {
            ...votes,
            timestamp: new Date().toLocaleString()
        });
        
        document.getElementById('page-4').classList.remove('active');
        document.getElementById('result').classList.add('active');
        
        setTimeout(() => location.reload(), 5000);
    } catch (e) {
        alert("Error saving vote. Check your internet.");
    }
};
